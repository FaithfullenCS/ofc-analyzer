<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –û–§–¶ - –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –≤–ª–∏—è–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞</title>
    <style>
        :root {
            --color-background: #fcfcf9;
            --color-surface: #fffffe;
            --color-text: #13343b;
            --color-text-secondary: #626c71;
            --color-primary: #21808d;
            --color-primary-hover: #1d7480;
            --color-primary-active: #1a6873;
            --color-secondary: rgba(94, 82, 64, 0.12);
            --color-secondary-hover: rgba(94, 82, 64, 0.2);
            --color-border: rgba(94, 82, 64, 0.2);
            --color-error: #c0152f;
            --color-success: #21808d;
            --color-warning: #a84b2f;
            --color-card-border: rgba(94, 82, 64, 0.12);
            --radius-base: 8px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-background: #1f2121;
                --color-surface: #262828;
                --color-text: #f5f5f5;
                --color-text-secondary: rgba(167, 169, 169, 0.7);
                --color-primary: #32b8c6;
                --color-primary-hover: #2da6b2;
                --color-primary-active: #2996a1;
                --color-secondary: rgba(119, 124, 124, 0.15);
                --color-secondary-hover: rgba(119, 124, 124, 0.25);
                --color-border: rgba(119, 124, 124, 0.3);
                --color-error: #ff5459;
                --color-success: #32b8c6;
                --color-warning: #e68161;
                --color-card-border: rgba(119, 124, 124, 0.2);
            }
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--color-background);
            color: var(--color-text);
            line-height: 1.5;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 24px;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .layout {
            display: grid;
            grid-template-columns: 320px 1fr 400px;
            gap: 20px;
        }

        @media (max-width: 1400px) {
            .layout {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-card-border);
            padding: 20px;
            box-shadow: var(--shadow-sm);
        }

        .panel h2 {
            font-size: 18px;
            margin-bottom: 16px;
            font-weight: 600;
        }

        .panel h3 {
            font-size: 14px;
            margin: 16px 0 8px 0;
            font-weight: 600;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 500;
            color: var(--color-text-secondary);
        }

        input, textarea, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            background: var(--color-surface);
            color: var(--color-text);
            font-size: 14px;
            transition: border-color 0.2s;
        }

        input:focus, textarea:focus, select:focus {
            outline: 2px solid var(--color-primary);
            border-color: var(--color-primary);
        }

        textarea {
            min-height: 100px;
            font-family: inherit;
            resize: vertical;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 16px;
            border: none;
            border-radius: var(--radius-base);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            gap: 6px;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-secondary {
            background: var(--color-secondary);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background: var(--color-secondary-hover);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status {
            padding: 8px 12px;
            border-radius: var(--radius-base);
            font-size: 13px;
            margin-top: 8px;
            display: none;
        }

        .status.success {
            background: rgba(33, 128, 141, 0.15);
            color: var(--color-success);
            border: 1px solid rgba(33, 128, 141, 0.25);
            display: block;
        }

        .status.error {
            background: rgba(192, 21, 47, 0.15);
            color: var(--color-error);
            border: 1px solid rgba(192, 21, 47, 0.25);
            display: block;
        }

        .counter {
            background: var(--color-secondary);
            padding: 16px;
            border-radius: var(--radius-base);
            margin-bottom: 16px;
        }

        .counter-text {
            font-size: 13px;
            color: var(--color-text-secondary);
            margin-bottom: 8px;
        }

        .counter-value {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .progress-bar {
            height: 8px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s, background 0.3s;
            background: var(--color-success);
        }

        .progress-fill.warning {
            background: var(--color-warning);
        }

        .progress-fill.danger {
            background: var(--color-error);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid var(--color-secondary);
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
            font-size: 13px;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }

        th {
            background: var(--color-secondary);
            font-weight: 600;
            color: var(--color-text-secondary);
        }

        .metrics {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .metric-group {
            background: var(--color-secondary);
            padding: 16px;
            border-radius: var(--radius-base);
        }

        .metric-group h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--color-border);
        }

        .metric-item:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-size: 13px;
            color: var(--color-text-secondary);
        }

        .metric-value {
            font-size: 14px;
            font-weight: 600;
        }

        .company-header {
            background: var(--color-secondary);
            padding: 16px;
            border-radius: var(--radius-base);
            margin-bottom: 16px;
        }

        .company-header h3 {
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 8px 0;
            color: var(--color-text);
            text-transform: none;
            letter-spacing: normal;
        }

        .company-info {
            font-size: 13px;
            color: var(--color-text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .scroll-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: var(--color-secondary);
            border-radius: 4px;
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 4px;
        }

        .scroll-container::-webkit-scrollbar-thumb:hover {
            background: var(--color-text-secondary);
        }

        .validation-hint {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞</h1>
        
        <div class="layout">
            <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Ñ–æ—Ä–º–∞ -->
            <div class="panel">
                <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                
                <div class="form-group">
                    <label for="backendUrl">Backend URL</label>
                    <input type="text" id="backendUrl" placeholder="https://your-app.vercel.app">
                </div>

                <div class="form-group">
                    <label for="apiKey">API –ö–ª—é—á Checko</label>
                    <input type="password" id="apiKey" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à API –∫–ª—é—á">
                </div>

                <button class="btn btn-secondary" onclick="checkConnection()">üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
                <div id="connectionStatus" class="status"></div>

                <h3>üìä –°—á–µ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤</h3>
                <div class="counter">
                    <div class="counter-text">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Å–µ–≥–æ–¥–Ω—è:</div>
                    <div class="counter-value"><span id="requestsUsed">0</span> / 100</div>
                    <div class="counter-text">–û—Å—Ç–∞–ª–æ—Å—å: <strong id="requestsRemaining">100</strong> –∑–∞–ø—Ä–æ—Å–æ–≤</div>
                    <div class="progress-bar">
                        <div id="progressBar" class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <h3>üîç –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h3>
                <div class="form-group">
                    <label for="inn">–ò–ù–ù –∫–æ–º–ø–∞–Ω–∏–∏</label>
                    <input type="text" id="inn" placeholder="7735560386" maxlength="12" pattern="[0-9]*">
                    <div class="validation-hint">–í–≤–µ–¥–∏—Ç–µ 10 –∏–ª–∏ 12 —Ü–∏—Ñ—Ä</div>
                </div>

                <button class="btn btn-primary" onclick="loadCompany()">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏—é</button>

                <div class="form-group" style="margin-top: 24px;">
                    <label for="innList">–ò–ª–∏ —Å–ø–∏—Å–æ–∫ –ò–ù–ù (–ø–æ –æ–¥–Ω–æ–º—É –≤ —Å—Ç—Ä–æ–∫–µ)</label>
                    <textarea id="innList" placeholder="7735560386&#10;7707083893&#10;7707329152"></textarea>
                    <div class="validation-hint" id="batchHint">–¢—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å–æ–≤: 0</div>
                </div>

                <button class="btn btn-primary" onclick="loadBatch()">üìã –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏</button>

                <div id="loadingIndicator" class="loading">
                    <div class="spinner"></div>
                    <div>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                </div>
            </div>

            <!-- –°—Ä–µ–¥–Ω—è—è –ø–∞–Ω–µ–ª—å: –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ -->
            <div class="panel">
                <h2>üíº –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>
                <div id="financialData">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <div>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π</div>
                    </div>
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ -->
            <div class="panel">
                <h2>üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h2>
                <div id="analysisResults">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìà</div>
                        <div>–ê–Ω–∞–ª–∏–∑ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        let currentData = null;
        let requestsUsed = 0;
        let remainingRequests = 100;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            updateRequestCounter(0, 100);
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ localStorage
        function loadSettings() {
            const backendUrl = localStorage.getItem('backendUrl') || '';
            const apiKey = localStorage.getItem('apiKey') || '';
            document.getElementById('backendUrl').value = backendUrl;
            document.getElementById('apiKey').value = apiKey;
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ localStorage
        function saveSettings() {
            const backendUrl = document.getElementById('backendUrl').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            localStorage.setItem('backendUrl', backendUrl);
            localStorage.setItem('apiKey', apiKey);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
        function updateRequestCounter(used, remaining) {
            requestsUsed = used;
            remainingRequests = remaining;
            
            document.getElementById('requestsUsed').textContent = used;
            document.getElementById('requestsRemaining').textContent = remaining;
            
            const percentage = (used / 100) * 100;
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percentage + '%';
            
            progressBar.className = 'progress-fill';
            if (percentage >= 95) {
                progressBar.classList.add('danger');
            } else if (percentage >= 80) {
                progressBar.classList.add('warning');
            }
        }

        async function parseJsonResponse(response) {
            const responseText = await response.text();
            let data;

            try {
                data = JSON.parse(responseText);
            } catch (e) {
                console.error('JSON parse error:', e);
                throw new Error(`–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç (–∫–æ–¥ ${response.status}): ${responseText.substring(0, 100)}...`);
            }

            if (!response.ok) {
                const error = new Error(data?.message || `–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª —Å—Ç–∞—Ç—É—Å ${response.status}`);
                error.status = response.status;
                error.body = data;
                throw error;
            }

            return data;
        }

        function formatErrorMessage(error) {
            const base = error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞';
            return error.status ? `–û—à–∏–±–∫–∞ (${error.status}): ${base}` : `–û—à–∏–±–∫–∞: ${base}`;
        }

        async function checkConnection() {
            const backendUrl = document.getElementById('backendUrl').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            const statusEl = document.getElementById('connectionStatus');

            if (!backendUrl || !apiKey) {
                statusEl.innerHTML = '‚ùå –í–≤–µ–¥–∏—Ç–µ Backend URL –∏ API –∫–ª—é—á';
                statusEl.className = 'status error';
                return;
            }

            statusEl.innerHTML = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...';
            statusEl.className = 'status';

            try {
                // –£–±–∏—Ä–∞–µ–º trailing slash –µ—Å–ª–∏ –µ—Å—Ç—å
                const cleanUrl = backendUrl.replace(/\/$/, '');

                console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞:', `${cleanUrl}/api/check-connection`);

                const response = await fetch(`${cleanUrl}/api/check-connection`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ apiKey })
                });

                const result = await parseJsonResponse(response);

                statusEl.innerHTML = `‚úÖ ${result.message}`;
                statusEl.className = 'status success';

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                localStorage.setItem('backendUrl', backendUrl);
                localStorage.setItem('apiKey', apiKey);

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
                updateRequestCounter(result.requestsUsedToday, result.remainingRequests);
            } catch (error) {
                console.error('Connection error:', error);
                statusEl.innerHTML = `‚ùå ${formatErrorMessage(error)}`;
                statusEl.className = 'status error';

                if (error.body?.requestsUsedToday !== undefined && error.body?.remainingRequests !== undefined) {
                    updateRequestCounter(error.body.requestsUsedToday, error.body.remainingRequests);
                }
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–¥–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏
        async function loadCompany() {
            const inn = document.getElementById('inn').value.trim();
            
            if (!validateINN(inn)) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ò–ù–ù (10 –∏–ª–∏ 12 —Ü–∏—Ñ—Ä)');
                return;
            }

            if (remainingRequests < 2) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –¢—Ä–µ–±—É–µ—Ç—Å—è –º–∏–Ω–∏–º—É–º 2 –∑–∞–ø—Ä–æ—Å–∞ (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è + —Ñ–∏–Ω–∞–Ω—Å—ã)');
                return;
            }

            saveSettings();
            const backendUrl = document.getElementById('backendUrl').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();

            showLoading(true);

            try {
                // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–º–ø–∞–Ω–∏–∏
                const companyResponse = await fetch(`${backendUrl}/api/company`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, inn })
                });

                const companyData = await parseJsonResponse(companyResponse);

                updateRequestCounter(companyData.requestsUsedToday, companyData.remainingRequests);

                // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                const financeResponse = await fetch(`${backendUrl}/api/finances`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, inn })
                });

                const financeData = await parseJsonResponse(financeResponse);

                updateRequestCounter(financeData.requestsUsedToday, financeData.remainingRequests);

                // –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
                currentData = {
                    company: companyData.data,
                    finances: financeData.data
                };

                displayFinancialData(currentData);
                displayAnalysis(currentData);

            } catch (error) {
                console.error('Load company error:', error);
                if (error.body?.requestsUsedToday !== undefined && error.body?.remainingRequests !== undefined) {
                    updateRequestCounter(error.body.requestsUsedToday, error.body.remainingRequests);
                }

                alert(formatErrorMessage(error));
            } finally {
                showLoading(false);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–æ–º–ø–∞–Ω–∏–π
        async function loadBatch() {
            const innList = document.getElementById('innList').value
                .split('\n')
                .map(inn => inn.trim())
                .filter(inn => inn && validateINN(inn));

            if (innList.length === 0) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ò–ù–ù –≤ —Å–ø–∏—Å–æ–∫');
                return;
            }

            const requiredRequests = innList.length * 2;
            
            if (remainingRequests < requiredRequests) {
                alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –¢—Ä–µ–±—É–µ—Ç—Å—è: ${requiredRequests}, –æ—Å—Ç–∞–ª–æ—Å—å: ${remainingRequests}`);
                return;
            }

            saveSettings();
            const backendUrl = document.getElementById('backendUrl').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();

            showLoading(true);

            try {
                const response = await fetch(`${backendUrl}/api/batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, innList })
                });

                const data = await parseJsonResponse(response);

                updateRequestCounter(data.requestsUsedToday, data.remainingRequests);

                // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ –∏–∑ —Å–ø–∏—Å–∫–∞
                if (data.data && data.data.length > 0) {
                    currentData = data.data[0];
                    displayFinancialData(currentData);
                    displayAnalysis(currentData);
                }

                alert(`–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ ${data.data.length} –∫–æ–º–ø–∞–Ω–∏–π`);

            } catch (error) {
                console.error('Batch load error:', error);

                if (error.body?.requestsUsedToday !== undefined && error.body?.remainingRequests !== undefined) {
                    updateRequestCounter(error.body.requestsUsedToday, error.body.remainingRequests);
                }

                alert(formatErrorMessage(error));
            } finally {
                showLoading(false);
            }
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –ò–ù–ù
        function validateINN(inn) {
            return /^\d{10}$|^\d{12}$/.test(inn);
        }

        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è displayFinancialData
function displayFinancialData(data) {
    const container = document.getElementById('financialData');

    // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å –∫ –¥–∞–Ω–Ω—ã–º –∫–æ–º–ø–∞–Ω–∏–∏
    const companyData = data.company?.data;
    const companyName = companyData?.–ù–∞–∏–º–°–æ–∫—Ä || companyData?.–ù–∞–∏–º–ü–æ–ª–Ω || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è';
    const inn = companyData?.–ò–ù–ù || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
    const status = companyData?.–°—Ç–∞—Ç—É—Å || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';

    let html = `
        <div class="company-header">
            <h3>${escapeHtml(companyName)}</h3>
            <div class="company-info">
                <div>–ò–ù–ù: ${inn}</div>
                <div>–°—Ç–∞—Ç—É—Å: ${status}</div>
            </div>
        </div>
    `;

    if (data.finances?.data) {
        const years = Object.keys(data.finances.data)
            .filter(key => key !== 'bo.nalog.ru' && key !== 'company')
            .sort();

        if (years.length > 0) {
            html += '<div class="scroll-container">';
            html += '<table><thead><tr><th>–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</th>';

            years.forEach(year => {
                html += `<th>${year}</th>`;
            });

            html += '</tr></thead><tbody>';

            const indicators = [
                { code: '1210', name: '–ó–∞–ø–∞—Å—ã' },
                { code: '1230', name: '–î–µ–±–∏—Ç–æ—Ä—Å–∫–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å' },
                { code: '1250', name: '–î–µ–Ω–µ–∂–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞' },
                { code: '1200', name: '–û–±–æ—Ä–æ—Ç–Ω—ã–µ –∞–∫—Ç–∏–≤—ã' },
                { code: '1520', name: '–ö—Ä–µ–¥–∏—Ç–æ—Ä—Å–∫–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å' },
                { code: '1500', name: '–ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞' },
                { code: '2110', name: '–í—ã—Ä—É—á–∫–∞' },
                { code: '2120', name: '–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å' },
                { code: '2400', name: '–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å' },
                { code: '1600', name: '–ê–∫—Ç–∏–≤—ã (–±–∞–ª–∞–Ω—Å)' },
                { code: '1300', name: '–ö–∞–ø–∏—Ç–∞–ª –∏ —Ä–µ–∑–µ—Ä–≤—ã' }
            ];

            indicators.forEach(indicator => {
                html += `<tr><td>${indicator.name}</td>`;
                years.forEach(year => {
                    const value = getExtendedValue(data.finances.data[year], indicator.code);
                    html += `<td>${formatNumber(value)}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table></div>';
        } else {
            html += '<div class="empty-state"><div>üìä</div><div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏</div></div>';
        }
    }

    container.innerHTML = html;
}

// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 3: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è displayAnalysis —Å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º–∏ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏
function displayAnalysis(data) {
    const container = document.getElementById('analysisResults');

    if (!data.finances?.data) {
        container.innerHTML = '<div class="empty-state"><div>üìä</div><div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</div></div>';
        return;
    }

    const years = Object.keys(data.finances.data)
        .filter(key => key !== 'bo.nalog.ru' && key !== 'company')
        .sort();

    if (years.length < 2) {
        container.innerHTML = '<div class="empty-state"><div>üìä</div><div>–î–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –º–∏–Ω–∏–º—É–º 2 –≥–æ–¥–∞ –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏</div></div>';
        return;
    }

    const latestYear = years[years.length - 1];
    const previousYear = years[years.length - 2];

    const currentData = data.finances.data[latestYear];
    const prevData = data.finances.data[previousYear];

    // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é getExtendedValue –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    const inventory = getExtendedValue(currentData, '1210');
    const inventoryPrev = getExtendedValue(prevData, '1210');

    const receivables = getExtendedValue(currentData, '1230');
    const receivablesPrev = getExtendedValue(prevData, '1230');

    const payables = getExtendedValue(currentData, '1520');
    const payablesPrev = getExtendedValue(prevData, '1520');

    const revenue = getExtendedValue(currentData, '2110');
    const cogs = getExtendedValue(currentData, '2120');

    // –°—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
    const avgInventory = (inventory + inventoryPrev) / 2;
    const avgReceivables = (receivables + receivablesPrev) / 2;
    const avgPayables = (payables + payablesPrev) / 2;

    // –†–∞—Å—á—ë—Ç –û–§–¶
    const poi = cogs !== 0 ? (365 * avgInventory) / cogs : 0;
    const ppd = revenue !== 0 ? (365 * avgReceivables) / revenue : 0;
    const ppa = cogs !== 0 ? (365 * avgPayables) / cogs : 0;
    const ofc = poi + ppd - ppa;

    // ‚úÖ –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏
    const currentAssets = getExtendedValue(currentData, '1200');
    const currentLiabilities = getExtendedValue(currentData, '1500');
    const cash = getExtendedValue(currentData, '1250');

    const currentRatio = currentLiabilities !== 0 ? currentAssets / currentLiabilities : 0;
    const quickRatio = currentLiabilities !== 0 ? (currentAssets - inventory) / currentLiabilities : 0;
    const absoluteRatio = currentLiabilities !== 0 ? cash / currentLiabilities : 0;

    // –ü—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç—å
    const netProfit = getExtendedValue(currentData, '2400');
    const totalAssets = getExtendedValue(currentData, '1600');
    const totalAssetsPrev = getExtendedValue(prevData, '1600');
    const equity = getExtendedValue(currentData, '1300');
    const equityPrev = getExtendedValue(prevData, '1300');

    const avgAssets = (totalAssets + totalAssetsPrev) / 2;
    const avgEquity = (equity + equityPrev) / 2;

    const roa = avgAssets !== 0 ? (netProfit / avgAssets) * 100 : 0;
    const roe = avgEquity !== 0 ? (netProfit / avgEquity) * 100 : 0;
    const grossMargin = revenue !== 0 ? ((revenue - cogs) / revenue) * 100 : 0;
    const netMargin = revenue !== 0 ? (netProfit / revenue) * 100 : 0;

    // –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å
    const totalLiabilities = getExtendedValue(currentData, '1400') + currentLiabilities;
    const autonomy = totalAssets !== 0 ? (equity / totalAssets) * 100 : 0;
    const leverage = equity !== 0 ? totalAssets / equity : 0;
    const debtRatio = totalAssets !== 0 ? (totalLiabilities / totalAssets) * 100 : 0;
    const debtToEquity = equity !== 0 ? totalLiabilities / equity : 0;

    let html = `
        <div class="metrics scroll-container">
            <div class="metric-group">
                <h4>üì¶ –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ü–∏–∫–ª</h4>
                <div class="metric-item">
                    <span class="metric-label">POI (–ü–µ—Ä–∏–æ–¥ –æ–±–æ—Ä–æ—Ç–∞ –∑–∞–ø–∞—Å–æ–≤)</span>
                    <span class="metric-value">${formatMetric(poi, 0)} –¥–Ω.</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">PPD (–ü–µ—Ä–∏–æ–¥ –ø–æ–≥–∞—à–µ–Ω–∏—è –¥–µ–±–∏—Ç–æ—Ä—Å–∫–æ–π –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏)</span>
                    <span class="metric-value">${formatMetric(ppd, 0)} –¥–Ω.</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">PPA (–ü–µ—Ä–∏–æ–¥ –ø–æ–≥–∞—à–µ–Ω–∏—è –∫—Ä–µ–¥–∏—Ç–æ—Ä—Å–∫–æ–π –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏)</span>
                    <span class="metric-value">${formatMetric(ppa, 0)} –¥–Ω.</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label"><strong>OFC (–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ü–∏–∫–ª)</strong></span>
                    <span class="metric-value"><strong>${formatMetric(ofc, 0)} –¥–Ω.</strong></span>
                </div>
            </div>

            <div class="metric-group">
                <h4>üíß –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏</h4>
                <div class="metric-item">
                    <span class="metric-label">–¢–µ–∫—É—â–∞—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å (–Ω–æ—Ä–º–∞: ‚â• 2.0)</span>
                    <span class="metric-value">${formatMetric(currentRatio, 2)}</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">–ë—ã—Å—Ç—Ä–∞—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å (–Ω–æ—Ä–º–∞: ‚â• 1.0)</span>
                    <span class="metric-value">${formatMetric(quickRatio, 2)}</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">–ê–±—Å–æ–ª—é—Ç–Ω–∞—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å (–Ω–æ—Ä–º–∞: ‚â• 0.2)</span>
                    <span class="metric-value">${formatMetric(absoluteRatio, 2)}</span>
                </div>
            </div>

            <div class="metric-group">
                <h4>üìä –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç–∏</h4>
                <div class="metric-item">
                    <span class="metric-label">ROA (–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –∞–∫—Ç–∏–≤–æ–≤)</span>
                    <span class="metric-value">${formatMetric(roa, 2)}%</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">ROE (–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∫–∞–ø–∏—Ç–∞–ª–∞)</span>
                    <span class="metric-value">${formatMetric(roe, 2)}%</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">–í–∞–ª–æ–≤–∞—è —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å</span>
                    <span class="metric-value">${formatMetric(grossMargin, 2)}%</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">–ß–∏—Å—Ç–∞—è —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å</span>
                    <span class="metric-value">${formatMetric(netMargin, 2)}%</span>
                </div>
            </div>

            <div class="metric-group">
                <h4>üèõÔ∏è –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å</h4>
                <div class="metric-item">
                    <span class="metric-label">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∞–≤—Ç–æ–Ω–æ–º–∏–∏</span>
                    <span class="metric-value">${formatMetric(autonomy, 2)}%</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä—ã—á–∞–≥</span>
                    <span class="metric-value">${formatMetric(leverage, 2)}</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–æ–ª–≥–∞</span>
                    <span class="metric-value">${formatMetric(debtRatio, 2)}%</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">D/E Ratio</span>
                    <span class="metric-value">${formatMetric(debtToEquity, 2)}</span>
                </div>
            </div>
        </div>
    `;

    container.innerHTML = html;
}


        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function showLoading(show) {
            const indicator = document.getElementById('loadingIndicator');
            indicator.className = show ? 'loading active' : 'loading';
        }

        function showStatus(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.textContent = message;
        }

        function formatNumber(value) {
            const num = parseFloat(value);
            if (isNaN(num)) return '0';
            return num.toLocaleString('ru-RU');
        }

        function formatMetric(value, decimals = 0) {
            if (isNaN(value) || !isFinite(value)) return '0';
            return value.toFixed(decimals);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ extended —Ñ–æ—Ä–º–∞—Ç–∞
        function getExtendedValue(data, code) {
            const value = data[code];
        
            // –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç (extended —Ñ–æ—Ä–º–∞—Ç)
            if (value && typeof value === 'object') {
                // –î–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å—Ç—Ä–æ–∫ –∏—Å–ø–æ–ª—å–∑—É–µ–º –°—É–º–û—Ç—á (—Å—É–º–º–∞ –∑–∞ –æ—Ç—á—ë—Ç–Ω—ã–π –≥–æ–¥)
                if (value.–°—É–º–û—Ç—á !== undefined) {
                    return parseFloat(value.–°—É–º–û—Ç—á) || 0;
                }
                // –î–ª—è —Å—Ç—Ä–æ–∫–∏ 3200 (–∫–∞–ø–∏—Ç–∞–ª) –∏—Å–ø–æ–ª—å–∑—É–µ–º –ò—Ç–æ–≥
                if (value.–ò—Ç–æ–≥ !== undefined) {
                    return parseFloat(value.–ò—Ç–æ–≥) || 0;
                }
                // –î–ª—è –û–§–† (—Å—Ç—Ä–æ–∫–∏ 4xxx) –∏—Å–ø–æ–ª—å–∑—É–µ–º –°—É–º–û—Ç—á
                if (value.–°—É–º–û—Ç—á !== undefined) {
                    return parseFloat(value.–°—É–º–û—Ç—á) || 0;
                }
            }
        
            // –ï—Å–ª–∏ —ç—Ç–æ —á–∏—Å–ª–æ (–æ–±—ã—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç) - –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º
            return parseFloat(value) || 0;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –±–∞—Ç—á-–∑–∞–≥—Ä—É–∑–∫–∏
        document.getElementById('innList').addEventListener('input', (e) => {
            const innList = e.target.value
                .split('\n')
                .map(inn => inn.trim())
                .filter(inn => inn && validateINN(inn));
            
            const required = innList.length * 2;
            const hint = document.getElementById('batchHint');
            
            if (required > remainingRequests) {
                hint.style.color = 'var(--color-error)';
                hint.textContent = `–¢—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å–æ–≤: ${required} (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, –æ—Å—Ç–∞–ª–æ—Å—å ${remainingRequests})`;
            } else {
                hint.style.color = 'var(--color-text-secondary)';
                hint.textContent = `–¢—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å–æ–≤: ${required}`;
            }
        });
    </script>
</body>
</html>
